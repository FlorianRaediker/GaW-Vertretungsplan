(function(){'use strict';function e(a,b=null){fetch("/api/report-error",{method:"post",body:new URLSearchParams({name:a.name,message:(null==b?void 0:b.message)||a.message,description:a.description,number:a.number,filename:(null==b?void 0:b.filename)||a.fileName,lineno:(null==b?void 0:b.lineno)||a.lineNumber,colno:(null==b?void 0:b.colno)||a.columnNumber,stack:(null==b?void 0:b.stack)||a.stack})}).catch(c=>console.error("reporting error failed",c))}window.addEventListener("error",a=>e(a.error,a));
window.addEventListener("unhandledrejection",a=>e(a.reason));const h=window.location.pathname.split("/",2)[1],l=document.getElementById("selectionInput").value;
if(window.location.hash.startsWith("#timetable:"))try{let [,a,b]=window.location.hash.split(":");b=atob(b);let c=!0,d;if(150!==b.length)console.warn("Timetable in URL has wrong length:",b.length,"instead of",150,b),c=!1;else{d=[];for(let g=0;5>g;g++){let f=[];d.push(f);for(let k=0;10>k;k++){let n=b.substr(30*g+3*k,3).trim();""===n&&(n=null);f.push(n)}}}if(c){let g;try{(g=JSON.parse(window.localStorage.getItem(h+"-timetables")))||(g={})}catch{g={}}a=a.toUpperCase();let f=a in g?"Die aufgerufenen URL enth\u00e4lt einen Stundenplan f\u00fcr "+
a+". Soll der aktuell gesetzte Stundenplan f\u00fcr "+a+" durch diesen ersetzt werden?":"Die aufgerufene URL enth\u00e4lt einen Stundenplan f\u00fcr "+a+". Diesen Stundenplan setzen?";if(l){let k=!1;for(let n of l.split(", "))if(n.toUpperCase()===a){k=!0;break}k||(f+=" Achtung: Der Stundenplan wird erst angewendet, wenn "+a+" auch ausgew\u00e4hlt ist.")}else f+=" Achtung: Der Stundenplan wird erst angewendet, wenn Vertretungen ausgew\u00e4hlt sind.";confirm(f)&&(g[a]=d,window.localStorage.setItem(h+
"-timetables",JSON.stringify(g)));window.location.hash=""}}catch(a){console.error("Error while retrieving timetable from URL",a),e(a)}function m(a,b){let c;try{c=JSON.parse(atob(document.cookie.split("; ").find(d=>d.startsWith("features=")).split("=")[1]))}catch{c={}}c[a]=b;document.cookie="features="+btoa(JSON.stringify(c))+";path=/;max-age=86400;Secure;SameSite=Lax"};const p=document.getElementsByClassName("date");
function q(){const a=new Date;if(0<p.length&&p[0].innerHTML===a.getDate()+"."+(a.getMonth()+1)+"."+a.getFullYear()){const b=a.getHours(),c=a.getMinutes();for(let d of[["1",8,35],["2",9,25],["3",10,30],["4",11,15],["5",12,20],["6",13,10],["7",14,35],["8",15,25],["9",16,20],["10",17,5]])if(d[1]<b||d[1]===b&&d[2]<=c)for(let g of document.getElementsByClassName("lesson"+d[0]))g.classList.add("grey");else{setTimeout(q,(new Date(a.getFullYear(),a.getMonth(),a.getDate(),d[1],d[2])).getTime()-a.getTime());
break}}}q();window.addEventListener("focus",()=>q());let r,t=document.getElementById("status").textContent;try{if(r=JSON.parse(window.localStorage.getItem(h+"-seen-substitutions")),r.status!==t){let a=Date.now();for(let b of Object.keys(r.seenSubstitutions))b<=a&&delete r.seenSubstitutions[b];for(let [b,c]of Object.entries(r.newSubstitutions))b>a&&(b in r.seenSubstitutions?r.seenSubstitutions[b].push(...c):r.seenSubstitutions[b]=c);r.newSubstitutions={};r.status=t}}catch{}r||(r={seenSubstitutions:{},newSubstitutions:{},status:t});
for(let a of document.getElementsByClassName("substitutions-box")){const b=a.querySelector(".substitutions-table tbody");if(b){const c=a.querySelector(".date").textContent.trim();let [,d,g,f]=c.match(/(\d\d?).(\d\d?).(\d\d\d\d)/);const k=Date.UTC(f,g-1,d+1);k in r.seenSubstitutions||(r.seenSubstitutions[k]=[]);k in r.newSubstitutions||(r.newSubstitutions[k]=[]);let n;for(let A of b.children){let E=A.querySelector(".group-name");null!=E&&(n=E.textContent.trim());let w=n;for(let F of A.children)F.classList.contains(".group-name")||
(w+="#"+F.textContent.trim());r.seenSubstitutions[k].includes(w)||(A.classList.add("new-subs"),r.newSubstitutions[k].includes(w)||r.newSubstitutions[k].push(w))}}}window.localStorage.setItem(h+"-seen-substitutions",JSON.stringify(r));const u=document.getElementById("toggle-notifications"),v=document.getElementById("notifications-info"),x=document.getElementById("notifications-info-none"),y=document.getElementById("notifications-info-all"),z=document.getElementById("notifications-info-selection"),B=document.getElementById("notifications-info-blocked"),C=document.getElementById("notifications-info-failed");
function D(a){var b="=".repeat((4-a.length%4)%4);a=(a+b).replace(/-/g,"+").replace(/_/g,"/");a=atob(a);b=new Uint8Array(a.length);for(let c=0;c<a.length;++c)b[c]=a.charCodeAt(c);return b}
function G(a,b,c){return new Promise((d,g)=>{b.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:D("BDu6tTwQHFlGb36-pLCzwMdgumSlyj_vqMR3I1KahllZd3v2se-LM25vhP3Yv_y0qXYx_KPOVOD2EYTaJaibzo8")}).then(f=>{console.log("Got push subscription:",f,a?"(active)":"(not active)");return fetch(window.location.origin+window.location.pathname+"api/subscribe-push",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:f.toJSON(),selection:l,is_active:a,user_triggered:c})})}).then(f=>
f.json()).then(f=>{f.ok?(console.log("Push subscription successful"),d()):(console.error("Push subscription failed",f),g())}).catch(f=>{console.error("Push subscription failed",f);g(f)})})}let H;
function I(a,b,c=!1){console.log("Setting notification-state to",a);H=a;"failed"!==a&&window.localStorage.setItem(h+"-notification-state",H);switch(H){case "granted-and-enabled":u.checked=!0;u.disabled=!1;v.innerHTML=""!==l?z.innerHTML.replace("{selection}",l):y.innerHTML;G(!0,b,c).catch(d=>{console.error("Push subscription failed",d);I("failed",b)});break;case "denied":u.checked=!1;u.disabled=!0;v.innerHTML=B.innerHTML;break;case "failed":u.checked=!1;u.disabled=!0;v.innerHTML=C.innerHTML;break;
case "granted-and-disabled":G(!1,b,c).catch(d=>{console.error("Push subscription failed",d);I("failed",b)});u.checked=!1;u.disabled=!1;v.innerHTML=x.innerHTML;break;default:case "default":u.checked=!1,u.disabled=!1,v.innerHTML=x.innerHTML}m("notifications",a)}
function J(a){function b(){return H.startsWith(Notification.permission)||"failed"===H?!1:(console.log(H+" changed to "+Notification.permission),"granted"===Notification.permission?I("granted-and-disabled",a):I(Notification.permission,a),!0)}document.getElementById("notifications-not-available-alert").hidden=!0;document.getElementById("toggle-notifications-wrapper").hidden=!1;u.addEventListener("change",()=>{u.checked?window.Notification.requestPermission().then(c=>{switch(c){case "granted":H="granted-and-enabled";
break;default:H=c}I(H,a,!0)}):"granted-and-enabled"===H&&I("granted-and-disabled",a,!0)});window.addEventListener("focus",b);H=window.localStorage.getItem(h+"-notification-state");if(null==H||"failed"===H)H="default";b()||I(H,a)}
"serviceWorker"in navigator?window.addEventListener("load",()=>{navigator.serviceWorker.ready.then(a=>{console.log("ServiceWorker is active:",a.active);"Notification"in window?"localStorage"in window?"PushManager"in window?J(a):console.warn("PushManager is not supported"):console.warn("localStorage is not supported"):console.warn("Notification is not supported")});navigator.serviceWorker.register("/sw.min.js").then(a=>{console.log("ServiceWorker registration successful:",a)}).catch(a=>console.warn("ServiceWorker registration failed:",
a))}):console.warn("serviceWorker is not supported");const K=document.getElementById("online-status");let L=null;function M(){K.textContent="Aktuell";K.classList.add("online");K.classList.remove("offline","updating")}function N(){K.textContent="Offline";K.classList.add("offline");K.classList.remove("online","updating")}
function O(a=null){L=new WebSocket(("http:"===window.location.protocol?"ws:":"wss:")+"//"+window.location.host+window.location.pathname+"api/wait-for-updates");L.addEventListener("open",b=>{console.log("WebSocket opened",b);M();a&&a(b.target)});L.addEventListener("close",b=>{console.log("WebSocket closed",b);N()});L.addEventListener("message",b=>{b=JSON.parse(b.data);console.log("WebSocket message",b);switch(b.type){case "status":(b=b.status)&&(b===document.getElementById("status").textContent?M():
window.location.reload());break;default:console.warn("Unknown WebSocket message type",b.type)}})}O();function P(){K.textContent="Aktualisiere...";K.classList.add("updating");K.classList.remove("online","offline");L.readyState===L.OPEN?L.send(JSON.stringify({type:"get_status"})):O(a=>a.send(JSON.stringify({type:"get_status"})))}window.addEventListener("focus",()=>{console.log("focus, checking for new substitutions");P()});
window.addEventListener("online",()=>{console.log("online, checking for new substitutions");P()});window.addEventListener("offline",()=>{console.log("offline");N()});document.getElementById("themes-block").appendChild(document.getElementById("themes-block-template").content);const Q=document.documentElement,R=document.getElementById("themes-system-default"),S=document.getElementById("themes-light"),T=document.getElementById("themes-dark");
function U(a){localStorage.setItem("theme",a);let b=a;switch(a){case "system-default":Q.classList.remove("light","dark");b="system-"+(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light");break;case "light":Q.classList.add("light");Q.classList.remove("dark");break;case "dark":Q.classList.add("dark"),Q.classList.remove("light")}m("theme",b)}switch(localStorage.getItem("theme")){case "light":S.checked=!0;break;case "dark":T.checked=!0}
R.addEventListener("change",()=>U("system-default"));S.addEventListener("change",()=>U("light"));T.addEventListener("change",()=>U("dark"));}).call(this);

//# sourceMappingURL=substitutions.min.js.map
