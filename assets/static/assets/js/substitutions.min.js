(function(){'use strict';function e(a,b=null){fetch("/api/report-error",{method:"post",body:new URLSearchParams({name:a.name,message:(null==b?void 0:b.message)||a.message,description:a.description,number:a.number,filename:(null==b?void 0:b.filename)||a.fileName,lineno:(null==b?void 0:b.lineno)||a.lineNumber,colno:(null==b?void 0:b.colno)||a.columnNumber,stack:(null==b?void 0:b.stack)||a.stack,user_agent:navigator.userAgent})})}window.addEventListener("error",a=>{e(a.error,a)});
window.addEventListener("unhandledrejection",a=>{console.log("unhandledrejection",a);e(a.reason)});const g=window.location.pathname.split("/",2)[1],h=document.getElementById("selectionInput").value;
if(window.location.hash.startsWith("#timetable:"))try{let [,a,b]=window.location.hash.split(":");b=JSON.parse(atob(b));if(5===b.length&&a){let c=!0;for(let d of b)if(10!==d.length){c=!1;break}if(c){let d;try{(d=JSON.parse(window.localStorage.getItem(g+"-timetables")))||(d={})}catch{d={}}a=a.toUpperCase();let f=a in d?"Die aufgerufenen URL enth\u00e4lt einen Stundenplan f\u00fcr "+a+". Soll der aktuell gesetzte Stundenplan f\u00fcr "+a+" durch diesen ersetzt werden?":"Die aufgerufene URL enth\u00e4lt einen Stundenplan f\u00fcr "+
a+". Diesen Stundenplan setzen?";if(h){let k=!1;for(let l of h.split(", "))if(l.toUpperCase()===a){k=!0;break}k||(f+=" Achtung: Der Stundenplan wird erst angewendet, wenn "+a+" auch ausgew\u00e4hlt ist.")}else f+=" Achtung: Der Stundenplan wird erst angewendet, wenn Vertretungen ausgew\u00e4hlt sind.";confirm(f)&&(d[a]=b,window.localStorage.setItem(g+"-timetables",JSON.stringify(d)));window.location.hash=""}}}catch{};const m=document.getElementsByClassName("date");
function n(){const a=new Date;if(0<m.length&&m[0].innerHTML===a.getDate()+"."+(a.getMonth()+1)+"."+a.getFullYear()){const b=a.getHours(),c=a.getMinutes();for(let d of[["1",8,35],["2",9,25],["3",10,30],["4",11,15],["5",12,20],["6",13,10],["7",14,35],["8",15,25],["9",16,20],["10",17,5]])if(d[1]<b||d[1]===b&&d[2]<=c)for(let f of document.getElementsByClassName("lesson"+d[0]))f.classList.add("grey");else{setTimeout(n,(new Date(a.getFullYear(),a.getMonth(),a.getDate(),d[1],d[2])).getTime()-a.getTime());
break}}}n();window.addEventListener("focus",()=>n());let p,q=document.getElementById("status").textContent;try{if(p=JSON.parse(window.localStorage.getItem(g+"-seen-substitutions")),p.status!==q){let a=Date.now();for(let b of Object.keys(p.seenSubstitutions))b<=a&&delete p.seenSubstitutions[b];for(let [b,c]of Object.entries(p.newSubstitutions))b>a&&(b in p.seenSubstitutions?p.seenSubstitutions[b].push(...c):p.seenSubstitutions[b]=c);p.newSubstitutions={};p.status=q}}catch{}p||(p={seenSubstitutions:{},newSubstitutions:{},status:q});
for(let a of document.getElementsByClassName("substitutions-box")){const b=a.querySelector(".substitutions-table tbody");if(b){const c=a.querySelector(".date").textContent.trim();let [,d,f,k]=c.match(/(\d\d).(\d\d).(\d\d\d\d)/);const l=Date.UTC(k,f-1,d+1);l in p.seenSubstitutions||(p.seenSubstitutions[l]=[]);l in p.newSubstitutions||(p.newSubstitutions[l]=[]);let A;for(let x of b.children){let B=x.querySelector(".group-name");null!=B&&(A=B.textContent.trim());let u=A;for(let C of x.children)C.classList.contains(".group-name")||
(u+="#"+C.textContent.trim());p.seenSubstitutions[l].includes(u)||(x.classList.add("new-subs"),p.newSubstitutions[l].includes(u)||p.newSubstitutions[l].push(u))}}}window.localStorage.setItem(g+"-seen-substitutions",JSON.stringify(p));const r=document.getElementById("toggle-notifications"),t=document.getElementById("notifications-info"),v=document.getElementById("notifications-info-none"),w=document.getElementById("notifications-info-all"),y=document.getElementById("notifications-info-selection"),z=document.getElementById("notifications-info-blocked"),D=document.getElementById("notifications-info-failed");
function E(a){var b="=".repeat((4-a.length%4)%4);a=(a+b).replace(/-/g,"+").replace(/_/g,"/");a=atob(a);b=new Uint8Array(a.length);for(let c=0;c<a.length;++c)b[c]=a.charCodeAt(c);return b}
function F(a,b){return new Promise((c,d)=>{b.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:E("BDu6tTwQHFlGb36-pLCzwMdgumSlyj_vqMR3I1KahllZd3v2se-LM25vhP3Yv_y0qXYx_KPOVOD2EYTaJaibzo8")}).then(f=>{console.log("Got push subscription:",f,a?"(active)":"(not active)");fetch(window.location.origin+window.location.pathname+"api/subscribe-push",{method:"post",headers:{"Content-Type":"application/json"},body:JSON.stringify({subscription:f.toJSON(),selection:h,is_active:a})}).then(k=>k.json()).then(k=>
{k.ok?(console.log("Push subscription successful"),c()):(console.error("Push subscription failed",k),d())})}).catch(f=>{console.error("Push subscription failed",f);d(f)})})}let G;
function H(a,b){console.log("Setting notification-state to",a);G=a;window.localStorage.setItem(g+"-notification-state",G);switch(G){case "granted-and-enabled":r.checked=!0;r.disabled=!1;t.innerHTML=""!==h?y.innerHTML.replace("{selection}",h):w.innerHTML;F(!0,b).catch(c=>{console.error("Push subscription failed",c);H("failed",b)});break;case "denied":r.checked=!1;r.disabled=!0;t.innerHTML=z.innerHTML;break;case "failed":r.checked=!1;r.disabled=!0;t.innerHTML=D.innerHTML;break;case "granted-and-disabled":F(!1,
b).catch(c=>{console.error("Push subscription failed",c);H("failed",b)});r.checked=!1;r.disabled=!1;t.innerHTML=v.innerHTML;break;default:case "default":r.checked=!1,r.disabled=!1,t.innerHTML=v.innerHTML}}
function I(a){function b(){return G.startsWith(Notification.permission)?!1:("granted"===Notification.permission?H("granted-and-disabled",a):H(Notification.permission,a),!0)}document.getElementById("notifications-not-available-alert").hidden=!0;document.getElementById("toggle-notifications-wrapper").hidden=!1;r.addEventListener("change",()=>{r.checked?window.Notification.requestPermission().then(c=>{switch(c){case "granted":G="granted-and-enabled";break;default:G=c}H(G,a)}):"granted-and-enabled"===
G&&H("granted-and-disabled",a)});window.addEventListener("focus",b);G=window.localStorage.getItem(g+"-notification-state");null==G&&(G="default");b()||H(G,a)}
"serviceWorker"in navigator?window.addEventListener("load",()=>{navigator.serviceWorker.ready.then(a=>{console.log("ServiceWorker is active:",a.active);"Notification"in window?"localStorage"in window?"PushManager"in window?I(a):console.warn("PushManager is not supported"):console.warn("localStorage is not supported"):console.warn("Notification is not supported")});navigator.serviceWorker.register("/sw.min.js").then(a=>{console.log("ServiceWorker registration successful:",a)}).catch(a=>console.warn("ServiceWorker registration failed:",
a))}):console.warn("serviceWorker is not supported");const J=document.getElementById("online-status");let K=null;function L(){J.textContent="Keine Verbindung zum Server";J.classList.add("offline");J.classList.remove("online")}
function M(a=null){K=new WebSocket(("http:"===window.location.protocol?"ws:":"wss:")+"//"+window.location.host+window.location.pathname+"api/wait-for-updates");K.addEventListener("open",b=>{console.log("WebSocket opened",b);J.textContent="Aktuell";J.classList.add("online");J.classList.remove("offline");a&&a()});K.addEventListener("close",b=>{console.log("WebSocket closed",b);L()});K.addEventListener("message",b=>{b=JSON.parse(b.data);console.log("WebSocket message",b);switch(b.type){case "new_substitutions":window.location.reload();
break;default:console.warn("Unknown WebSocket message type")}})}M();function N(){K.readyState===K.OPEN?K.send(JSON.stringify({type:"check_status",status:document.getElementById("status").textContent})):M(()=>K.send(JSON.stringify({type:"check_status",status:document.getElementById("status").textContent})))}window.addEventListener("focus",()=>{console.log("focus, checking for new substitutions");N()});window.addEventListener("online",()=>{console.log("online, checking for new substitutions");N()});
window.addEventListener("offline",()=>{console.log("offline, closing WebSocket connection");L();K.close()});}).call(this);

//# sourceMappingURL=substitutions.min.js.map
