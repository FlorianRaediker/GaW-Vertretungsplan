{"version":3,"sources":["assets/static/assets/js/substitutions.js"],"names":["dates","document","getElementsByClassName","greySubstitutions","now","Date","length","innerHTML","getDate","getMonth","getFullYear","b2","getHours","c2","getMinutes","i","x","classList","add","setTimeout","getTime","substitutionPlanType","window","location","pathname","split","onlineStatus","getElementById","webSocket","createWebSocket","openCallback","WebSocket","protocol","host","addEventListener","event","textContent","remove","console","log","msg","JSON","parse","data","type","reload","warn","close","updateWebSocket","readyState","OPEN","send","stringify","status","selection","value","toggleNotifications","notificationsInfo","notificationsInfo_none","notificationsInfo_all","notificationsInfo_selection","notificationsInfo_blocked","notificationsInfo_failed","base64UrlToUint8Array","base64UrlData","padding","repeat","base64","replace","rawData","atob","buffer","Uint8Array","charCodeAt","subscribePush","isActive","registration","Promise","resolve","reject","pushManager","subscribe","userVisibleOnly","applicationServerKey","then","subscription","fetch","origin","method","body","toJSON","is_active","response","json","ok","error","catch","reason","notificationState","setNotificationsInfo","state","localStorage","setItem","checked","disabled","onNotificationsAvailable","reloadPermissionState","startsWith","Notification","permission","hidden","requestPermission","getItem","navigator","serviceWorker","ready","active","register"],"mappings":"A,aAGA,MAAMA,EAAQC,QAAA,CAASC,sBAAT,CAAgC,MAAhC,CAEdC;QAASA,EAAiB,EAAG,CACzB,MAAMC,EAAM,IAAIC,IAChB,IAAmB,CAAnB,CAAIL,CAAJ,CAAUM,MAAV,EAAwBN,CAAA,CAAM,CAAN,CAAxB,CAAiCO,SAAjC,GAA+CH,CAAA,CAAII,OAAJ,EAA/C,CAA+D,GAA/D,EAAsEJ,CAAA,CAAIK,QAAJ,EAAtE,CAAuF,CAAvF,EAA4F,GAA5F,CAAkGL,CAAA,CAAIM,WAAJ,EAAlG,CAAqH,CACjH,MAAMC,EAAKP,CAAA,CAAIQ,QAAJ,EAAX,CACMC,EAAKT,CAAA,CAAIU,UAAJ,EACX,KAAK,IAAIC,CAAT,GAAc,CACV,CAAC,GAAD,CAAM,CAAN,CAAS,EAAT,CADU,CAEV,CAAC,GAAD,CAAM,CAAN,CAAS,EAAT,CAFU,CAGV,CAAC,GAAD,CAAM,EAAN,CAAU,EAAV,CAHU,CAIV,CAAC,GAAD,CAAM,EAAN,CAAU,EAAV,CAJU,CAKV,CAAC,GAAD,CAAM,EAAN,CAAU,EAAV,CALU,CAMV,CAAC,GAAD,CAAM,EAAN,CAAU,EAAV,CANU,CAOV,CAAC,GAAD,CAAM,EAAN,CAAU,EAAV,CAPU,CAQV,CAAC,GAAD,CAAM,EAAN,CAAU,EAAV,CARU,CASV,CAAC,GAAD,CAAM,EAAN,CAAU,EAAV,CATU,CAUV,CAAC,IAAD,CAAO,EAAP,CAAW,CAAX,CAVU,CAAd,CAYI,GAAIA,CAAA,CAAE,CAAF,CAAJ,CAAWJ,CAAX,EAAkBI,CAAA,CAAE,CAAF,CAAlB,GAA2BJ,CAA3B,EAAiCI,CAAA,CAAE,CAAF,CAAjC,EAAyCF,CAAzC,CACI,IAAK,IAAIG,CAAT,GAAcf,SAAA,CAASC,sBAAT,CAAgC,QAAhC,CAA2Ca,CAAA,CAAE,CAAF,CAA3C,CAAd,CACIC,CAAA,CAAEC,SAAF,CAAYC,GAAZ,CAAgB,MAAhB,CAFR,KAIO,CAEHC,UAAA,CAAWhB,CAAX,CAA8B,CAAA,IAAIE,IAAJ,CAASD,CAAA,CAAIM,WAAJ,EAAT,CAA4BN,CAAA,CAAIK,QAAJ,EAA5B,CAA4CL,CAAA,CAAII,OAAJ,EAA5C,CAA2DO,CAAA,CAAE,CAAF,CAA3D,CAAiEA,CAAA,CAAE,CAAF,CAAjE,CAAA,EAAuEK,OAAvE,EAA9B,CAAiHhB,CAAA,CAAIgB,OAAJ,EAAjH,CACA;KAHG,CAnBsG,CAF5F,CA8B7BjB,CAAA,EAIA,KAAIkB,EAAuBC,MAAA,CAAOC,QAAP,CAAgBC,QAAhB,CAAyBC,KAAzB,CAA+B,GAA/B,CAAoC,CAApC,CAAA,CAAuC,CAAvC,CAM3B,OAAMC,EAAezB,QAAA,CAAS0B,cAAT,CAAwB,eAAxB,CAErB,KAAIC,EAAY,IAChBC;QAASA,EAAe,CAACC,CAAA,CAAa,IAAd,CAAoB,CACxCF,CAAA,CAAY,IAAIG,SAAJ,EACsB,OAA7B,GAAAT,MAAA,CAAOC,QAAP,CAAgBS,QAAhB,CAAuC,KAAvC,CAA+C,MADxC,EACkD,IADlD,CAERV,MAFQ,CAEDC,QAFC,CAEQU,IAFR,CAEeX,MAFf,CAEsBC,QAFtB,CAE+BC,QAF/B,CAE0C,sBAF1C,CAIZI,EAAA,CAAUM,gBAAV,CAA2B,MAA3B,CAAmCC,CAAA,EAAS,CACxCT,CAAA,CAAaU,WAAb,CAA2B,SAC3BV,EAAA,CAAaT,SAAb,CAAuBC,GAAvB,CAA2B,QAA3B,CACAQ,EAAA,CAAaT,SAAb,CAAuBoB,MAAvB,CAA8B,SAA9B,CACAC,QAAA,CAAQC,GAAR,CAAY,kBAAZ,CAAgCJ,CAAhC,CACIL,EAAJ,EACIA,CAAA,EANoC,CAA5C,CAQAF,EAAA,CAAUM,gBAAV,CAA2B,OAA3B,CAAoCC,CAAA,EAAS,CAEzCT,CAAA,CAAaU,WAAb,CAA2B,6BAC3BV,EAAA,CAAaT,SAAb,CAAuBC,GAAvB,CAA2B,SAA3B,CACAQ,EAAA,CAAaT,SAAb,CAAuBoB,MAAvB,CAA8B,QAA9B,CACAC,QAAA,CAAQC,GAAR,CAAY,kBAAZ,CAAgCJ,CAAhC,CALyC,CAA7C,CAOAP,EAAA,CAAUM,gBAAV,CAA2B,SAA3B;AAAsCC,CAAA,EAAS,CACrCK,CAAAA,CAAMC,IAAA,CAAKC,KAAL,CAAWP,CAAX,CAAiBQ,IAAjB,CACZL,QAAA,CAAQC,GAAR,CAAY,mBAAZ,CAAiCC,CAAjC,CACA,QAAQA,CAAR,CAAYI,IAAZ,EAII,KAAK,mBAAL,CACItB,MAAA,CAAOC,QAAP,CAAgBsB,MAAhB,EACA,MACJ,SACIP,OAAA,CAAQQ,IAAR,CAAa,gCAAb,CARR,CAH2C,CAA/C,CAeAxB,OAAA,CAAOY,gBAAP,CAAwB,SAAxB,CAAmC,EAAA,EAAM,CACrCI,OAAA,CAAQC,GAAR,CAAY,uCAAZ,CACAX,EAAA,CAAUmB,KAAV,EAFqC,CAAzC,CAnCwC,CAwC5ClB,CAAA,EAEAmB;QAASA,EAAe,EAAG,CAGnBpB,CAAJ,CAAcqB,UAAd,GAA6BrB,CAA7B,CAAuCsB,IAAvC,CACItB,CAAA,CAAUuB,IAAV,CAAeV,IAAA,CAAKW,SAAL,CAAe,CAACR,KAAM,cAAP,CAAuBS,OAAQpD,QAAA,CAAS0B,cAAT,CAAwB,QAAxB,CAAR0B,CAA0CjB,WAAjE,CAAf,CAAf,CADJ,CAGIP,CAAA,CAAgB,EAAA,EAAMD,CAAA,CAAUuB,IAAV,CAAeV,IAAA,CAAKW,SAAL,CAAe,CAACR,KAAM,cAAP,CAAuBS,OAAQpD,QAAA,CAAS0B,cAAT,CAAwB,QAAxB,CAAR0B,CAA0CjB,WAAjE,CAAf,CAAf,CAAtB,CANmB,CAU3Bd,MAAA,CAAOY,gBAAP,CAAwB,OAAxB,CAAiC,EAAA,EAAM,CACnCI,OAAA,CAAQC,GAAR,CAAY,uCAAZ,CACAS,EAAA,EAFmC,CAAvC,CAKA1B,OAAA,CAAOY,gBAAP,CAAwB,QAAxB,CAAkC,EAAA,EAAM,CACpCI,OAAA,CAAQC,GAAR,CAAY,wCAAZ,CACAS,EAAA,EAFoC,CAAxC,CASA;MAAMM,EAAYrD,QAAA,CAAS0B,cAAT,CAAwB,gBAAxB,CAAZ2B,CAAsDC,KAA5D,CAEMC,EAAsBvD,QAAA,CAAS0B,cAAT,CAAwB,sBAAxB,CAF5B,CAGM8B,EAAoBxD,QAAA,CAAS0B,cAAT,CAAwB,oBAAxB,CAH1B,CAIM+B,EAAyBzD,QAAA,CAAS0B,cAAT,CAAwB,yBAAxB,CAJ/B,CAKMgC,EAAwB1D,QAAA,CAAS0B,cAAT,CAAwB,wBAAxB,CAL9B,CAMMiC,EAA8B3D,QAAA,CAAS0B,cAAT,CAAwB,8BAAxB,CANpC,CAOMkC,EAA4B5D,QAAA,CAAS0B,cAAT,CAAwB,4BAAxB,CAPlC,CAQMmC,EAA2B7D,QAAA,CAAS0B,cAAT,CAAwB,2BAAxB,CAEjCoC;QAASA,EAAqB,CAACC,CAAD,CAAgB,CAC1C,IAAMC,EAAUC,GAAA,CAAIA,MAAJ,EAAY,CAAZ,CAAgBF,CAAhB,CAA8B1D,MAA9B,CAAuC,CAAvC,EAA4C,CAA5C,CACV6D,EAAAA,CAAS,CAACH,CAAD,CAAiBC,CAAjB,EACVG,OADU,CACF,IADE,CACI,GADJ,CAAA,CAEVA,OAFU,CAEF,IAFE,CAEI,GAFJ,CAITC,EAAAA,CAAUC,IAAA,CAAKH,CAAL,CACVI,EAAAA,CAAS,IAAIC,UAAJ,CAAeH,CAAf,CAAuB/D,MAAvB,CAEf,KAAK,IAAIS,EAAI,CAAb,CAAgBA,CAAhB,CAAoBsD,CAApB,CAA4B/D,MAA5B,CAAoC,EAAES,CAAtC,CACIwD,CAAA,CAAOxD,CAAP,CAAA,CAAYsD,CAAA,CAAQI,UAAR,CAAmB1D,CAAnB,CAGhB,OAAOwD,EAbmC;AAgB9CG,QAASA,EAAa,CAACC,CAAD,CAAWC,CAAX,CAAyB,CAC3C,MAAO,KAAIC,OAAJ,CAAY,CAACC,CAAD,CAAUC,CAAV,CAAA,EAAqB,CACpCH,CAAA,CAAaI,WAAb,CAAyBC,SAAzB,CAAmC,CAC/BC,gBAAiB,CAAA,CADc,CAE/BC,qBAAsBpB,CAAA,CAAsB,yFAAtB,CAFS,CAAnC,CAAA,CAGGqB,IAHH,CAGQC,CAAA,EAAgB,CACpB/C,OAAA,CAAQC,GAAR,CAAY,wBAAZ,CAAsC8C,CAAtC,CAAoDV,CAAA,CAAW,UAAX,CAAwB,cAA5E,CACAW,MAAA,CAAMhE,MAAN,CAAaC,QAAb,CAAsBgE,MAAtB,CAA+BjE,MAA/B,CAAsCC,QAAtC,CAA+CC,QAA/C,CAA0D,oBAA1D,CAAgF,CAC5EgE,OAAQ,MADoE,CAE5E,QAAW,CACP,eAAgB,kBADT,CAFiE,CAK5EC,KAAMhD,IAAA,CAAKW,SAAL,CAAe,CAACiC,aAAcA,CAAA,CAAaK,MAAb,EAAf,CAAsCpC,UAAWA,CAAjD,CAA4DqC,UAAWhB,CAAvE,CAAf,CALsE,CAAhF,CAAA,CAOKS,IAPL,CAOUQ,CAAA,EAAYA,CAAA,CAASC,IAAT,EAPtB,CAAA,CAQKT,IARL,CAQUzC,CAAA;AAAQ,CACNA,CAAJ,CAASmD,EAAT,EACIxD,OAAA,CAAQC,GAAR,CAAY,8BAAZ,CACA,CAAAuC,CAAA,EAFJ,GAIIxC,OAAA,CAAQyD,KAAR,CAAc,0BAAd,CAA0CpD,CAA1C,CACA,CAAAoC,CAAA,EALJ,CADU,CARlB,CAFoB,CAHxB,CAAA,CAsBGiB,KAtBH,CAsBSC,CAAA,EAAU,CACf3D,OAAA,CAAQyD,KAAR,CAAc,0BAAd,CAA0CE,CAA1C,CACAlB,EAAA,CAAOkB,CAAP,CAFe,CAtBnB,CADoC,CAAjC,CADoC,CAgC/C,IAAIC,CAEJC;QAASA,EAAoB,CAACC,CAAD,CAAQxB,CAAR,CAAsB,CAC/CtC,OAAA,CAAQC,GAAR,CAAY,+BAAZ,CAA6C6D,CAA7C,CACAF,EAAA,CAAoBE,CACpB9E,OAAA,CAAO+E,YAAP,CAAoBC,OAApB,CAA4BjF,CAA5B,CAAmD,qBAAnD,CAA0E6E,CAA1E,CACA,QAAQA,CAAR,EACI,KAAK,qBAAL,CACI1C,CAAA,CAAoB+C,OAApB,CAA8B,CAAA,CAC9B/C,EAAA,CAAoBgD,QAApB,CAA+B,CAAA,CAE3B/C,EAAA,CAAkBlD,SAAlB,CADc,EAAlB,GAAI+C,CAAJ,CACkCM,CAAA,CAA4BrD,SAA5B,CAAsC6D,OAAtC,CAA8C,aAA9C,CAA6Dd,CAA7D,CADlC,CAGkCK,CAHlC,CAGwDpD,SAExDmE,EAAA,CAAc,CAAA,CAAd,CAAoBE,CAApB,CAAA,CACKoB,KADL,CACWC,CAAA,EAAU,CACb3D,OAAA,CAAQyD,KAAR,CAAc,0BAAd,CAA0CE,CAA1C,CACAE,EAAA,CAAqB,QAArB,CAA+BvB,CAA/B,CAFa,CADrB,CAKA,MACJ,MAAK,QAAL,CACIpB,CAAA,CAAoB+C,OAApB,CAA8B,CAAA,CAC9B/C,EAAA,CAAoBgD,QAApB,CAA+B,CAAA,CAC/B/C,EAAA,CAAkBlD,SAAlB,CAA8BsD,CAA9B,CAAwDtD,SACxD,MACJ,MAAK,QAAL,CACIiD,CAAA,CAAoB+C,OAApB,CAA8B,CAAA,CAC9B/C,EAAA,CAAoBgD,QAApB,CAA+B,CAAA,CAC/B/C,EAAA,CAAkBlD,SAAlB,CAA8BuD,CAA9B,CAAuDvD,SACvD,MACJ,MAAK,sBAAL,CACImE,CAAA,CAAc,CAAA,CAAd;AAAqBE,CAArB,CAAA,CACKoB,KADL,CACWC,CAAA,EAAU,CACb3D,OAAA,CAAQyD,KAAR,CAAc,0BAAd,CAA0CE,CAA1C,CACAE,EAAA,CAAqB,QAArB,CAA+BvB,CAA/B,CAFa,CADrB,CAKApB,EAAA,CAAoB+C,OAApB,CAA8B,CAAA,CAC9B/C,EAAA,CAAoBgD,QAApB,CAA+B,CAAA,CAC/B/C,EAAA,CAAkBlD,SAAlB,CAA8BmD,CAA9B,CAAqDnD,SACrD,MACJ,SACA,KAAK,SAAL,CACIiD,CAEA,CAFoB+C,OAEpB,CAF8B,CAAA,CAE9B,CADA/C,CACA,CADoBgD,QACpB,CAD+B,CAAA,CAC/B,CAAA/C,CAAA,CAAkBlD,SAAlB,CAA8BmD,CAA9B,CAAqDnD,SAvC7D,CAJ+C;AAgDnDkG,QAASA,EAAwB,CAAC7B,CAAD,CAAe,CAuB5C8B,QAASA,EAAqB,EAAG,CAC7B,MAAKR,EAAA,CAAkBS,UAAlB,CAA6BC,YAA7B,CAA0CC,UAA1C,CAAL,CASO,CAAA,CATP,EAEoC,SAAhC,GAAID,YAAJ,CAAiBC,UAAjB,CACIV,CAAA,CAAqB,sBAArB,CAA6CvB,CAA7C,CADJ,CAGIuB,CAAA,CAAqBS,YAArB,CAAkCC,UAAlC,CAA8CjC,CAA9C,CAEG,CAAA,CAAA,CAPX,CAD6B,CAtBjC3E,QAAA,CAAS0B,cAAT,CAAwB,mCAAxB,CAAA,CAA6DmF,MAA7D,CAAsE,CAAA,CACtE7G,SAAA,CAAS0B,cAAT,CAAwB,8BAAxB,CAAA,CAAwDmF,MAAxD,CAAiE,CAAA,CACjEtD,EAAA,CAAoBtB,gBAApB,CAAqC,QAArC,CAA+C,EAAA,EAAM,CAC7CsB,CAAJ,CAAwB+C,OAAxB,CACIjF,MAAA,CAAOsF,YAAP,CAAoBG,iBAApB,EAAA,CACK3B,IADL,CACUyB,CAAA,EAAc,CAChB,OAAQA,CAAR,EACI,KAAK,SAAL,CACIX,CAAA,CAAoB,qBACpB,MACJ,SACIA,CAAA,CAAoBW,CAL5B,CAOAV,CAAA,CAAqBD,CAArB,CAAwCtB,CAAxC,CARgB,CADxB,CADJ,CAa8B,qBAb9B;AAaQsB,CAbR,EAcQC,CAAA,CAAqB,sBAArB,CAA6CvB,CAA7C,CAfyC,CAArD,CAgCAtD,OAAA,CAAOY,gBAAP,CAAwB,OAAxB,CAAiCwE,CAAjC,CAEAR,EAAA,CAAoB5E,MAAA,CAAO+E,YAAP,CAAoBW,OAApB,CAA4B3F,CAA5B,CAAmD,qBAAnD,CACK,KAAzB,EAAI6E,CAAJ,GACIA,CADJ,CACwB,SADxB,CAEKQ,EAAA,EAAL,EACIP,CAAA,CAAqBD,CAArB,CAAwCtB,CAAxC,CAzCwC;AA6C5C,eAAJ,EAAuBqC,UAAvB,CACI3F,MAAA,CAAOY,gBAAP,CAAwB,MAAxB,CAAgC,EAAA,EAAM,CAClC+E,SAAA,CAAUC,aAAV,CAAwBC,KAAxB,CACK/B,IADL,CACUR,CAAA,EAAgB,CAClBtC,OAAA,CAAQC,GAAR,CAAY,0BAAZ,CAAwCqC,CAAxC,CAAqDwC,MAArD,CACM,eAAN,EAAwB9F,OAAxB,CAIM,cAAN,EAAwBA,OAAxB,CAIM,aAAN,EAAuBA,OAAvB,CAIAmF,CAAA,CAAyB7B,CAAzB,CAJA,CACItC,OAAA,CAAQQ,IAAR,CAAa,8BAAb,CALJ,CACIR,OAAA,CAAQQ,IAAR,CAAa,+BAAb,CALJ,CACIR,OAAA,CAAQQ,IAAR,CAAa,+BAAb,CAHc,CAD1B,CAiBAmE,UAAA,CAAUC,aAAV,CAAwBG,QAAxB,CAAiC,YAAjC,CAAA,CACKjC,IADL,CACUR,CAAA,EAAgB,CAClBtC,OAAA,CAAQC,GAAR,CAAY,wCAAZ,CAAsDqC,CAAtD,CADkB,CAD1B,CAAA,CAGOoB,KAHP,CAGaC,CAAA,EAAU3D,OAAA,CAAQQ,IAAR,CAAa,oCAAb;AAAmDmD,CAAnD,CAHvB,CAlBkC,CAAtC,CADJ,CAyBI3D,OAAA,CAAQQ,IAAR,CAAa,gCAAb","file":"substitutions.min.js","sourcesContent":["// ==================\r\n// GREY SUBSTITUTIONS\r\n\r\nconst dates = document.getElementsByClassName(\"date\");\r\n\r\nfunction greySubstitutions() {\r\n    const now = new Date();\r\n    if (dates.length > 0 && dates[0].innerHTML === now.getDate() + \".\" + (now.getMonth() + 1) + \".\" + now.getFullYear()) {\r\n        const b2 = now.getHours();\r\n        const c2 = now.getMinutes();\r\n        for (let i of [\r\n            [\"1\", 8, 35],\r\n            [\"2\", 9, 25],\r\n            [\"3\", 10, 30],\r\n            [\"4\", 11, 15],\r\n            [\"5\", 12, 20],\r\n            [\"6\", 13, 10],\r\n            [\"7\", 14, 35],\r\n            [\"8\", 15, 25],\r\n            [\"9\", 16, 20],\r\n            [\"10\", 17, 5]\r\n        ]) {\r\n            if (i[1] < b2 || (i[1] === b2 && i[2] <= c2)) {\r\n                for (let x of document.getElementsByClassName(\"lesson\" + i[0])) {\r\n                    x.classList.add(\"grey\");\r\n                }\r\n            } else {\r\n                // noinspection JSCheckFunctionSignatures\r\n                setTimeout(greySubstitutions, new Date(now.getFullYear(), now.getMonth(), now.getDate(), i[1], i[2]).getTime() - now.getTime());\r\n                break\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\ngreySubstitutions();\r\n\r\n\r\n\r\nlet substitutionPlanType = window.location.pathname.split(\"/\", 2)[1];\r\n\r\n\r\n// =================\r\n// WEBSOCKET UPDATES\r\n\r\nconst onlineStatus = document.getElementById(\"online-status\");\r\n\r\nlet webSocket = null;\r\nfunction createWebSocket(openCallback=null) {\r\n    webSocket = new WebSocket(\r\n        (window.location.protocol === \"http:\" ? \"ws:\" : \"wss:\") + \"//\" +\r\n        window.location.host + window.location.pathname + \"api/wait-for-updates\");\r\n\r\n    webSocket.addEventListener(\"open\", event => {\r\n        onlineStatus.textContent = \"Aktuell\";\r\n        onlineStatus.classList.add(\"online\");\r\n        onlineStatus.classList.remove(\"offline\");\r\n        console.log(\"WebSocket opened\", event);\r\n        if (openCallback)\r\n            openCallback();\r\n    });\r\n    webSocket.addEventListener(\"close\", event => {\r\n        //clearInterval(heartbeatInterval);\r\n        onlineStatus.textContent = \"Keine Verbindung zum Server\";\r\n        onlineStatus.classList.add(\"offline\");\r\n        onlineStatus.classList.remove(\"online\");\r\n        console.log(\"WebSocket closed\", event);\r\n    });\r\n    webSocket.addEventListener(\"message\", event => {\r\n        const msg = JSON.parse(event.data);\r\n        console.log(\"WebSocket message\", msg);\r\n        switch (msg.type) {\r\n            /*case \"heartbeat\":\r\n                clearTimeout(disconnectTimeout);\r\n                break;*/\r\n            case \"new_substitutions\":\r\n                window.location.reload();\r\n                break;\r\n            default:\r\n                console.warn(\"Unknown WebSocket message type\");\r\n                break;\r\n        }\r\n    });\r\n    window.addEventListener(\"offline\", () => {\r\n        console.log(\"offline, closing WebSocket connection\");\r\n        webSocket.close();\r\n    });\r\n}\r\ncreateWebSocket();\r\n\r\nfunction updateWebSocket() {\r\n    // Send status to server. The server checks whether the status is still up-to-date. If not, it sends a\r\n    // message, and thus the page is reloaded.\r\n    if (webSocket.readyState === webSocket.OPEN) {\r\n        webSocket.send(JSON.stringify({type: \"check_status\", status: document.getElementById(\"status\").textContent}));\r\n    } else {\r\n        createWebSocket(() => webSocket.send(JSON.stringify({type: \"check_status\", status: document.getElementById(\"status\").textContent})));\r\n    }\r\n}\r\n\r\nwindow.addEventListener(\"focus\", () => {\r\n    console.log(\"focus, checking for new substitutions\");\r\n    updateWebSocket();\r\n});\r\n\r\nwindow.addEventListener(\"online\", () => {\r\n    console.log(\"online, checking for new substitutions\");\r\n    updateWebSocket();\r\n});\r\n\r\n\r\n// ============\r\n// PUSH NOTIFICATIONS\r\n\r\nconst selection = document.getElementById(\"selectionInput\").value;\r\n\r\nconst toggleNotifications = document.getElementById(\"toggle-notifications\");\r\nconst notificationsInfo = document.getElementById(\"notifications-info\");\r\nconst notificationsInfo_none = document.getElementById(\"notifications-info-none\");\r\nconst notificationsInfo_all = document.getElementById(\"notifications-info-all\");\r\nconst notificationsInfo_selection = document.getElementById(\"notifications-info-selection\");\r\nconst notificationsInfo_blocked = document.getElementById(\"notifications-info-blocked\");\r\nconst notificationsInfo_failed = document.getElementById(\"notifications-info-failed\");\r\n\r\nfunction base64UrlToUint8Array(base64UrlData) {\r\n    const padding = '='.repeat((4 - base64UrlData.length % 4) % 4);\r\n    const base64 = (base64UrlData + padding)\r\n        .replace(/-/g, '+')\r\n        .replace(/_/g, '/');\r\n\r\n    const rawData = atob(base64);\r\n    const buffer = new Uint8Array(rawData.length);\r\n\r\n    for (let i = 0; i < rawData.length; ++i) {\r\n        buffer[i] = rawData.charCodeAt(i);\r\n    }\r\n\r\n    return buffer;\r\n}\r\n\r\nfunction subscribePush(isActive, registration) {\r\n    return new Promise((resolve, reject) => {\r\n        registration.pushManager.subscribe({\r\n            userVisibleOnly: true,\r\n            applicationServerKey: base64UrlToUint8Array(\"BDu6tTwQHFlGb36-pLCzwMdgumSlyj_vqMR3I1KahllZd3v2se-LM25vhP3Yv_y0qXYx_KPOVOD2EYTaJaibzo8\")\r\n        }).then(subscription => {\r\n            console.log(\"Got push subscription:\", subscription, isActive ? \"(active)\" : \"(not active)\");\r\n            fetch(window.location.origin + window.location.pathname + \"api/subscribe-push\", {\r\n                method: \"post\",\r\n                \"headers\": {\r\n                    \"Content-Type\": \"application/json\"\r\n                },\r\n                body: JSON.stringify({subscription: subscription.toJSON(), selection: selection, is_active: isActive})\r\n            })\r\n                .then(response => response.json())\r\n                .then(data => {\r\n                    if (data.ok) {\r\n                        console.log(\"Push subscription successful\");\r\n                        resolve();\r\n                    } else {\r\n                        console.error(\"Push subscription failed\", data);\r\n                        reject();\r\n                    }\r\n                });\r\n        }).catch(reason => {\r\n            console.error(\"Push subscription failed\", reason);\r\n            reject(reason);\r\n        });\r\n    });\r\n}\r\n\r\n\r\nlet notificationState;\r\n\r\nfunction setNotificationsInfo(state, registration) {\r\n    console.log(\"Setting notification-state to\", state);\r\n    notificationState = state;\r\n    window.localStorage.setItem(substitutionPlanType + \"-notification-state\", notificationState);\r\n    switch (notificationState) {\r\n        case \"granted-and-enabled\":\r\n            toggleNotifications.checked = true;\r\n            toggleNotifications.disabled = false;\r\n            if (selection !== \"\") {\r\n                notificationsInfo.innerHTML = notificationsInfo_selection.innerHTML.replace(\"{selection}\", selection);\r\n            } else {\r\n                notificationsInfo.innerHTML = notificationsInfo_all.innerHTML;\r\n            }\r\n            subscribePush(true, registration)\r\n                .catch(reason => {\r\n                    console.error(\"Push subscription failed\", reason);\r\n                    setNotificationsInfo(\"failed\", registration);\r\n                });\r\n            break;\r\n        case \"denied\":\r\n            toggleNotifications.checked = false;\r\n            toggleNotifications.disabled = true;\r\n            notificationsInfo.innerHTML = notificationsInfo_blocked.innerHTML;\r\n            break;\r\n        case \"failed\":\r\n            toggleNotifications.checked = false;\r\n            toggleNotifications.disabled = true;\r\n            notificationsInfo.innerHTML = notificationsInfo_failed.innerHTML;\r\n            break;\r\n        case \"granted-and-disabled\":\r\n            subscribePush(false, registration)\r\n                .catch(reason => {\r\n                    console.error(\"Push subscription failed\", reason);\r\n                    setNotificationsInfo(\"failed\", registration);\r\n                });\r\n            toggleNotifications.checked = false;\r\n            toggleNotifications.disabled = false;\r\n            notificationsInfo.innerHTML = notificationsInfo_none.innerHTML;\r\n            break;\r\n        default:\r\n        case \"default\":\r\n            toggleNotifications.checked = false;\r\n            toggleNotifications.disabled = false;\r\n            notificationsInfo.innerHTML = notificationsInfo_none.innerHTML;\r\n            break;\r\n    }\r\n}\r\n\r\nfunction onNotificationsAvailable(registration) {\r\n    document.getElementById(\"notifications-not-available-alert\").hidden = true;\r\n    document.getElementById(\"toggle-notifications-wrapper\").hidden = false;\r\n    toggleNotifications.addEventListener(\"change\", () => {\r\n        if (toggleNotifications.checked) {\r\n            window.Notification.requestPermission()\r\n                .then(permission => {\r\n                    switch (permission) {\r\n                        case \"granted\":\r\n                            notificationState = \"granted-and-enabled\";\r\n                            break;\r\n                        default:\r\n                            notificationState = permission;\r\n                    }\r\n                    setNotificationsInfo(notificationState, registration);\r\n                });\r\n        } else {\r\n            if (notificationState === \"granted-and-enabled\") {\r\n                setNotificationsInfo(\"granted-and-disabled\", registration);\r\n            }\r\n        }\r\n    });\r\n\r\n    function reloadPermissionState() {\r\n        if (!notificationState.startsWith(Notification.permission)) {\r\n            // permission has been changed\r\n            if (Notification.permission === \"granted\") {\r\n                setNotificationsInfo(\"granted-and-disabled\", registration);\r\n            } else {\r\n                setNotificationsInfo(Notification.permission, registration);\r\n            }\r\n            return true;\r\n        }\r\n        return false;\r\n    }\r\n    window.addEventListener(\"focus\", reloadPermissionState);\r\n\r\n    notificationState = window.localStorage.getItem(substitutionPlanType + \"-notification-state\");\r\n    if (notificationState == null)\r\n        notificationState = \"default\";\r\n    if (!reloadPermissionState()) {\r\n        setNotificationsInfo(notificationState, registration);\r\n    }\r\n}\r\n\r\nif (\"serviceWorker\" in navigator) {\r\n    window.addEventListener(\"load\", () => {\r\n        navigator.serviceWorker.ready\r\n            .then(registration => {\r\n                console.log(\"ServiceWorker is active:\", registration.active);\r\n                if (!(\"Notification\" in window)) {\r\n                    console.warn(\"Notification is not supported\");\r\n                    return;\r\n                }\r\n                if (!(\"localStorage\" in window)) {\r\n                    console.warn(\"localStorage is not supported\");\r\n                    return;\r\n                }\r\n                if (!(\"PushManager\" in window)) {\r\n                    console.warn(\"PushManager is not supported\");\r\n                    return;\r\n                }\r\n                onNotificationsAvailable(registration);\r\n            });\r\n        navigator.serviceWorker.register(\"/sw.min.js\")\r\n            .then(registration => {\r\n                console.log(\"ServiceWorker registration successful:\", registration);\r\n            }).catch(reason => console.warn(\"ServiceWorker registration failed:\", reason))\r\n    });\r\n} else {\r\n    console.warn(\"serviceWorker is not supported\");\r\n}\r\n"]}