{"version":3,"sources":["assets/static/assets/js/substitutions.js"],"names":["dates","document","getElementsByClassName","greySubstitutions","now","Date","length","innerHTML","getDate","getMonth","getFullYear","b2","getHours","c2","getMinutes","i","x","classList","add","setTimeout","getTime","substitutionPlanType","window","location","pathname","split","onlineStatus","getElementById","isWebSocketOnline","createWebSocket","ws","WebSocket","protocol","host","addEventListener","event","textContent","remove","console","log","msg","JSON","parse","data","type","reload","warn","close","createNewWebSocket","send","stringify","status","selection","value","toggleNotifications","notificationsInfo","notificationsInfo_none","notificationsInfo_all","notificationsInfo_selection","notificationsInfo_blocked","notificationsInfo_failed","base64UrlToUint8Array","base64UrlData","padding","repeat","base64","replace","rawData","atob","buffer","Uint8Array","charCodeAt","subscribePush","isActive","registration","Promise","resolve","reject","pushManager","subscribe","userVisibleOnly","applicationServerKey","then","subscription","fetch","origin","method","body","toJSON","is_active","response","json","ok","error","catch","reason","notificationState","setNotificationsInfo","state","localStorage","setItem","checked","disabled","onNotificationsAvailable","reloadPermissionState","startsWith","Notification","permission","hidden","requestPermission","getItem","navigator","serviceWorker","ready","active","register"],"mappings":"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","file":"substitutions.min.js","sourcesContent":["// ==================\n// GREY SUBSTITUTIONS\n\nconst dates = document.getElementsByClassName(\"date\");\n\nfunction greySubstitutions() {\n    const now = new Date();\n    if (dates.length > 0 && dates[0].innerHTML === now.getDate() + \".\" + (now.getMonth() + 1) + \".\" + now.getFullYear()) {\n        const b2 = now.getHours();\n        const c2 = now.getMinutes();\n        for (let i of [\n            [\"1\", 8, 35],\n            [\"2\", 9, 25],\n            [\"3\", 10, 30],\n            [\"4\", 11, 15],\n            [\"5\", 12, 20],\n            [\"6\", 13, 10],\n            [\"7\", 14, 35],\n            [\"8\", 15, 25],\n            [\"9\", 16, 20],\n            [\"10\", 17, 5]\n        ]) {\n            if (i[1] < b2 || (i[1] === b2 && i[2] <= c2)) {\n                for (let x of document.getElementsByClassName(\"lesson\" + i[0])) {\n                    x.classList.add(\"grey\");\n                }\n            } else {\n                // noinspection JSCheckFunctionSignatures\n                setTimeout(greySubstitutions, new Date(now.getFullYear(), now.getMonth(), now.getDate(), i[1], i[2]).getTime() - now.getTime());\n                break\n            }\n        }\n    }\n}\n\ngreySubstitutions();\n\n\n\nlet substitutionPlanType = window.location.pathname.split(\"/\", 2)[1];\n\n\n// =================\n// WEBSOCKET UPDATES\n\nconst onlineStatus = document.getElementById(\"online-status\");\nlet isWebSocketOnline = false;\n\nfunction createWebSocket() {\n    if (isWebSocketOnline) return null;\n    const ws = new WebSocket(\n        (window.location.protocol === \"http:\" ? \"ws:\" : \"wss:\") + \"//\" +\n        window.location.host + window.location.pathname + \"api/wait-for-updates\");\n\n    /*let heartbeatInterval;\n    let disconnectTimeout;*/\n\n    ws.addEventListener(\"open\", event => {\n        isWebSocketOnline = true;\n        onlineStatus.textContent = \"Aktuell\";\n        onlineStatus.classList.add(\"online\");\n        onlineStatus.classList.remove(\"offline\");\n        /*heartbeatInterval = setInterval(() => {\n            if (hasFocus) {\n                disconnectTimeout = setTimeout(() => ws.close(), 14000); // give server 14 seconds to respond\n                ws.send('{\"heartbeat\": true}');\n            }\n        }, 15000);*/\n        console.log(\"WebSocket opened\", event);\n    });\n    ws.addEventListener(\"close\", event => {\n        //clearInterval(heartbeatInterval);\n        isWebSocketOnline = false;\n        onlineStatus.textContent = \"Keine Verbindung zum Server\";\n        onlineStatus.classList.add(\"offline\");\n        onlineStatus.classList.remove(\"online\");\n        console.log(\"WebSocket closed\", event);\n    });\n    ws.addEventListener(\"message\", event => {\n        const msg = JSON.parse(event.data);\n        console.log(\"WebSocket message\", msg);\n        switch (msg.type) {\n            /*case \"heartbeat\":\n                clearTimeout(disconnectTimeout);\n                break;*/\n            case \"new_substitutions\":\n                window.location.reload();\n                break;\n            default:\n                console.warn(\"Unknown WebSocket message type\");\n                break;\n        }\n    });\n    window.addEventListener(\"offline\", () => {\n        console.log(\"offline, closing WebSocket connection\");\n        ws.close();\n    });\n    return ws;\n}\ncreateWebSocket();\n\nfunction createNewWebSocket() {\n    // called after connection has been lost\n    const ws = createWebSocket();\n    if (ws != null) {\n        ws.addEventListener(\"open\", () => {\n            // Send status to server. The server checks whether the status is still up-to-date. If not, it sends a\n            // message, and thus the page is reloaded.\n            ws.send(JSON.stringify({type: \"check_status\", status: document.getElementById(\"status\").textContent}));\n        });\n    }\n}\n\nlet hasFocus = true;\n\nwindow.addEventListener(\"focus\", () => {\n    hasFocus = true;\n    createNewWebSocket();\n});\n\nwindow.addEventListener(\"online\", () => {\n    console.log(\"online\");\n    createNewWebSocket();\n});\n\n\n// ============\n// PUSH NOTIFICATIONS\n\nconst selection = document.getElementById(\"selectionInput\").value;\n\nconst toggleNotifications = document.getElementById(\"toggle-notifications\");\nconst notificationsInfo = document.getElementById(\"notifications-info\");\nconst notificationsInfo_none = document.getElementById(\"notifications-info-none\");\nconst notificationsInfo_all = document.getElementById(\"notifications-info-all\");\nconst notificationsInfo_selection = document.getElementById(\"notifications-info-selection\");\nconst notificationsInfo_blocked = document.getElementById(\"notifications-info-blocked\");\nconst notificationsInfo_failed = document.getElementById(\"notifications-info-failed\");\n\nfunction base64UrlToUint8Array(base64UrlData) {\n    const padding = '='.repeat((4 - base64UrlData.length % 4) % 4);\n    const base64 = (base64UrlData + padding)\n        .replace(/-/g, '+')\n        .replace(/_/g, '/');\n\n    const rawData = atob(base64);\n    const buffer = new Uint8Array(rawData.length);\n\n    for (let i = 0; i < rawData.length; ++i) {\n        buffer[i] = rawData.charCodeAt(i);\n    }\n\n    return buffer;\n}\n\nfunction subscribePush(isActive, registration) {\n    return new Promise((resolve, reject) => {\n        registration.pushManager.subscribe({\n            userVisibleOnly: true,\n            applicationServerKey: base64UrlToUint8Array(\"BDu6tTwQHFlGb36-pLCzwMdgumSlyj_vqMR3I1KahllZd3v2se-LM25vhP3Yv_y0qXYx_KPOVOD2EYTaJaibzo8\")\n        }).then(subscription => {\n            console.log(\"Got push subscription:\", subscription, isActive ? \"(active)\" : \"(not active)\");\n            fetch(window.location.origin + window.location.pathname + \"api/subscribe-push\", {\n                method: \"post\",\n                \"headers\": {\n                    \"Content-Type\": \"application/json\"\n                },\n                body: JSON.stringify({subscription: subscription.toJSON(), selection: selection, is_active: isActive})\n            })\n                .then(response => response.json())\n                .then(data => {\n                    if (data.ok) {\n                        console.log(\"Push subscription successful\");\n                        resolve();\n                    } else {\n                        console.error(\"Push subscription failed\");\n                        reject();\n                    }\n                });\n        }).catch(reason => {\n            console.error(\"Push subscription failed\", reason);\n            reject(reason);\n        });\n    });\n}\n\n\nlet notificationState;\n\nfunction setNotificationsInfo(state, registration) {\n    console.log(\"Setting notification-state to\", state);\n    notificationState = state;\n    window.localStorage.setItem(substitutionPlanType + \"-notification-state\", notificationState);\n    switch (notificationState) {\n        case \"granted-and-enabled\":\n            toggleNotifications.checked = true;\n            toggleNotifications.disabled = false;\n            if (selection !== \"\") {\n                notificationsInfo.innerHTML = notificationsInfo_selection.innerHTML.replace(\"{selection}\", selection);\n            } else {\n                notificationsInfo.innerHTML = notificationsInfo_all.innerHTML;\n            }\n            subscribePush(true, registration)\n                .catch(() => {\n                    setNotificationsInfo(\"failed\", registration);\n                });\n            break;\n        case \"denied\":\n            toggleNotifications.checked = false;\n            toggleNotifications.disabled = true;\n            notificationsInfo.innerHTML = notificationsInfo_blocked.innerHTML;\n            break;\n        case \"failed\":\n            toggleNotifications.checked = false;\n            toggleNotifications.disabled = true;\n            notificationsInfo.innerHTML = notificationsInfo_failed.innerHTML;\n            break;\n        case \"granted-and-disabled\":\n            subscribePush(false, registration)\n                .catch(() => {\n                    setNotificationsInfo(\"failed\", registration);\n                });\n            toggleNotifications.checked = false;\n            toggleNotifications.disabled = false;\n            notificationsInfo.innerHTML = notificationsInfo_none.innerHTML;\n            break;\n        default:\n        case \"default\":\n            toggleNotifications.checked = false;\n            toggleNotifications.disabled = false;\n            notificationsInfo.innerHTML = notificationsInfo_none.innerHTML;\n            break;\n    }\n}\n\nfunction onNotificationsAvailable(registration) {\n    document.getElementById(\"notifications-block\").hidden = false;\n    toggleNotifications.addEventListener(\"change\", () => {\n        if (toggleNotifications.checked) {\n            window.Notification.requestPermission()\n                .then(permission => {\n                    switch (permission) {\n                        case \"granted\":\n                            notificationState = \"granted-and-enabled\";\n                            break;\n                        default:\n                            notificationState = permission;\n                    }\n                    setNotificationsInfo(notificationState, registration);\n                });\n        } else {\n            if (notificationState === \"granted-and-enabled\") {\n                setNotificationsInfo(\"granted-and-disabled\", registration);\n            }\n        }\n    });\n\n    function reloadPermissionState() {\n        if (!notificationState.startsWith(Notification.permission)) {\n            // permission has been changed\n            if (Notification.permission === \"granted\") {\n                setNotificationsInfo(\"granted-and-disabled\", registration);\n            } else {\n                setNotificationsInfo(Notification.permission, registration);\n            }\n            return true;\n        }\n        return false;\n    }\n    window.addEventListener(\"focus\", reloadPermissionState);\n\n    notificationState = window.localStorage.getItem(substitutionPlanType + \"-notification-state\");\n    if (notificationState == null)\n        notificationState = \"default\";\n    if (!reloadPermissionState()) {\n        setNotificationsInfo(notificationState, registration);\n    }\n}\n\nif (\"serviceWorker\" in navigator) {\n    window.addEventListener(\"load\", () => {\n        navigator.serviceWorker.ready\n            .then(registration => {\n                console.log(\"ServiceWorker is active:\", registration.active);\n                if (!(\"Notification\" in window)) {\n                    console.warn(\"Notification is not supported\");\n                    return;\n                }\n                if (!(\"localStorage\" in window)) {\n                    console.warn(\"localStorage is not supported\");\n                    return;\n                }\n                onNotificationsAvailable(registration);\n            });\n        navigator.serviceWorker.register(\"/sw.min.js\")\n            .then(registration => {\n                console.log(\"ServiceWorker registration successful:\", registration);\n            }).catch(reason => console.warn(\"ServiceWorker registration failed:\", reason))\n    });\n} else {\n    console.warn(\"serviceWorker is not supported\");\n}\n"]}